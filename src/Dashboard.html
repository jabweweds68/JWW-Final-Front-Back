<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JWW Dashboard</title>
    <link rel="icon" type="image/png" href="./assets/images/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="./assets/images/favicon.svg" />
    <link rel="shortcut icon" href="./assets/images/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="./assets/images/apple-touch-icon.png" />
    <link rel="manifest" href="./assets/images/site.webmanifest" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/src/Dashboard.css">
    <link rel="stylesheet" href="Dashboard.css">
    <script type="module" src="./js/routeProtection.js"></script>
</head>
<style></style>


<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <i class="fas fa-store"></i>
                <span>JWW Dashboard</span>
            </div>
            <div class="nav-menu">
                <a href="#" class="nav-link active" onclick="switchPage('products')">
                    <i class="fas fa-boxes"></i>
                    Products
                </a>
                <a href="#" class="nav-link" onclick="switchPage('orders')">
                    <i class="fas fa-shopping-cart"></i>
                    Orders
                </a>
            </div>
            <div class="nav-toggle" onclick="toggleMobileMenu()">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <div class="dashboard">
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <h1>All Products </h1>
                    <p>Streamlined product management for modern businesses</p>
                </div>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalProducts">0</h3>
                    <p>Total Products</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalVariants">0</h3>
                    <p>Size Variants</p>
                </div>
                <div class="stat-card">
                    <h3 id="availableProducts">0</h3>
                    <p>Available</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalCategories">0</h3>
                    <p>Categories</p>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="content-header">
                <h2 class="content-title">
                    <i class="fas fa-boxes"></i>
                    Products
                </h2>
                <button class="add-btn" onclick="openAddModal()">
                    <i class="fas fa-plus"></i>
                    Add Product
                </button>
            </div>

            <div class="table-container">
                <table class="product-table" id="productTable">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Product Details</th>
                            <th>Category</th>
                            <th>Size Variants</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productTableBody">
                        <!-- Products will be inserted here -->
                    </tbody>
                </table>
                <div id="emptyState" class="empty-state" style="display: none;">
                    <i class="fas fa-box-open"></i>
                    <h3>No products found</h3>
                    <p>Start by adding your first product to get started</p>
                </div>
                <div id="loadingState" class="loading-state" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading products...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">
                    <i class="fas fa-plus-circle"></i>
                    Add Product
                </h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="productForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label class="form-label">Product Title</label>
                        <input type="text" class="form-input" id="productTitle" placeholder="Enter product title"
                            required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-input" id="productDescription" rows="3"
                            placeholder="Describe your product" required></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select class="form-input" id="productCategory" required>
                            <option value="">Select a category</option>
                            <option value="Strawberry Flavour">Strawberry Flavour</option>
                            <option value="Dark Desire">Dark Desire</option>
                            <option value="Vanilla Lust">Vanilla Lust</option>
                            <option value="Bundle of 3 Flavours">Bundle of 3 Flavours</option>
                        </select>
                    </div>

                    <!-- Image Upload Section -->
                    <div class="form-group" id="imageUploadSection">
                        <label class="form-label">Product Images</label>

                        <!-- Small Size Images -->
                        <div class="image-upload-section">
                            <div class="image-section-title">
                                <i class="fas fa-images"></i>
                                Small Size Images (Max 8: 1 Cover + 7 Body)
                            </div>
                            <div class="additional-images-grid" id="smallSizeImagesGrid">
                                <!-- 8 slots will be generated by JS -->
                            </div>
                            <input type="file" id="smallSizeImagesInput" accept="image/*" multiple
                                style="display: none;" onchange="handleSmallSizeImages(event)">
                            <button type="button" class="btn-secondary"
                                onclick="document.getElementById('smallSizeImagesInput').click()">
                                <i class="fas fa-upload"></i>
                                Upload Small Size Images
                            </button>
                            <small class="form-help">First image will be the cover photo for Small size. You can upload
                                up to 8 images.</small>
                        </div>

                        <!-- Large Size Images -->
                        <div class="image-upload-section">
                            <div class="image-section-title">
                                <i class="fas fa-images"></i>
                                Large Size Images (Max 8: 1 Cover + 7 Body)
                            </div>
                            <div class="additional-images-grid" id="largeSizeImagesGrid">
                                <!-- 8 slots will be generated by JS -->
                            </div>
                            <input type="file" id="largeSizeImagesInput" accept="image/*" multiple
                                style="display: none;" onchange="handleLargeSizeImages(event)">
                            <button type="button" class="btn-secondary"
                                onclick="document.getElementById('largeSizeImagesInput').click()">
                                <i class="fas fa-upload"></i>
                                Upload Large Size Images
                            </button>
                            <small class="form-help">First image will be the cover photo for Large size. You can upload
                                up to 8 images.</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Size Variants & Pricing</label>
                        <div class="size-variants-container">
                            <div id="sizeVariantsContainer">
                            </div>
                            <button type="button" class="add-variant-btn" onclick="addSizeVariant()">
                                <i class="fas fa-plus"></i>
                                Add Size Variant
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="button" class="btn-primary" onclick="saveProduct()" id="saveBtn">
                    <i class="fas fa-save"></i>
                    Save Product
                </button>
            </div>
        </div>
    </div>


    <!-- View Product Modal -->
    <div id="viewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-eye"></i>
                    Product Details
                </h2>
                <span class="close" onclick="closeViewModal()">&times;</span>
            </div>
            <div class="modal-body" id="viewModalBody">
                <!-- Product details will be shown here -->
            </div>
        </div>
    </div>


    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Processing...</p>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notificationToast" class="notification-toast">
        <div class="toast-content">
            <i id="toastIcon" class="fas fa-check-circle"></i>
            <span id="toastMessage">Success message</span>
        </div>
    </div>

    <!-- Hidden file input for image updates -->
    <input type="file" id="hiddenImageUpdateInput" class="hidden-file-input" accept="image/*"
        onchange="handleImageUpdate(event)">

    <script>
        const CONFIG = {
            // BACKEND_URL: 'http://localhost:8000'
            BACKEND_URL: 'https://jww-backend-main-production.up.railway.app'
        };

        const API_BASE_URL = CONFIG.BACKEND_URL;

        let products = [];
        let editingProductId = null;
        let smallSizeImages = [];
        let largeSizeImages = [];
        let currentImageBeingUpdated = { productId: null, imageId: null };

        // Navigation
        function switchPage(page) {
            if (page === 'orders') {
                window.location.href = 'orders.html';
            }
        }

        function toggleMobileMenu() {
            const navMenu = document.querySelector('.nav-menu');
            const navToggle = document.querySelector('.nav-toggle');
            navMenu.classList.toggle('active');
            navToggle.classList.toggle('active');
        }

        // Initialize
        async function initializeData() {
            await loadProducts();
        }

        // Initialize image grids
        function initializeImageUploadSections() {
            const smallGrid = document.getElementById('smallSizeImagesGrid');
            const largeGrid = document.getElementById('largeSizeImagesGrid');

            if (!smallGrid || !largeGrid) return;

            smallGrid.innerHTML = '';
            for (let i = 0; i < 8; i++) {
                const slot = document.createElement('div');
                slot.className = 'image-preview empty';
                slot.id = `smallSlot${i}`;
                slot.innerHTML = `<i class="fas fa-${i === 0 ? 'image' : 'plus'}"></i><span>${i === 0 ? 'Cover' : i}</span>`;
                smallGrid.appendChild(slot);
            }

            largeGrid.innerHTML = '';
            for (let i = 0; i < 8; i++) {
                const slot = document.createElement('div');
                slot.className = 'image-preview empty';
                slot.id = `largeSlot${i}`;
                slot.innerHTML = `<i class="fas fa-${i === 0 ? 'image' : 'plus'}"></i><span>${i === 0 ? 'Cover' : i}</span>`;
                largeGrid.appendChild(slot);
            }
        }

        // Handle image uploads
        function handleSmallSizeImages(event) {
            const files = Array.from(event.target.files);
            const remainingSlots = 8 - smallSizeImages.length;

            if (files.length > remainingSlots) {
                showNotification(`You can only add ${remainingSlots} more images for Small size`, 'error');
                event.target.value = '';
                return;
            }

            for (let file of files) {
                if (file.size > 5 * 1024 * 1024) {
                    showNotification(`Image ${file.name} is larger than 5MB`, 'error');
                    continue;
                }
                if (smallSizeImages.length < 8) {
                    smallSizeImages.push(file);
                }
            }

            updateImageGrid('small');
            event.target.value = '';
        }

        function handleLargeSizeImages(event) {
            const files = Array.from(event.target.files);
            const remainingSlots = 8 - largeSizeImages.length;

            if (files.length > remainingSlots) {
                showNotification(`You can only add ${remainingSlots} more images for Large size`, 'error');
                event.target.value = '';
                return;
            }

            for (let file of files) {
                if (file.size > 5 * 1024 * 1024) {
                    showNotification(`Image ${file.name} is larger than 5MB`, 'error');
                    continue;
                }
                if (largeSizeImages.length < 8) {
                    largeSizeImages.push(file);
                }
            }

            updateImageGrid('large');
            event.target.value = '';
        }

        function updateImageGrid(sizeType) {
            const images = sizeType === 'small' ? smallSizeImages : largeSizeImages;
            const prefix = sizeType === 'small' ? 'smallSlot' : 'largeSlot';

            for (let i = 0; i < 8; i++) {
                const slot = document.getElementById(`${prefix}${i}`);
                if (!slot) continue;

                if (i < images.length) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        slot.innerHTML = `
                    <img src="${e.target.result}" alt="${sizeType} image ${i}">
                    <button type="button" class="image-remove-btn" onclick="removeImage('${sizeType}', ${i})">×</button>
                    ${i === 0 ? '<div class="cover-badge">Cover</div>' : ''}
                `;
                        slot.classList.remove('empty');
                        slot.classList.add('filled');
                    };
                    reader.readAsDataURL(images[i]);
                } else {
                    slot.innerHTML = `<i class="fas fa-${i === 0 ? 'image' : 'plus'}"></i><span>${i === 0 ? 'Cover' : i}</span>`;
                    slot.classList.add('empty');
                    slot.classList.remove('filled');
                }
            }
        }

        function removeImage(sizeType, index) {
            if (sizeType === 'small') {
                smallSizeImages.splice(index, 1);
                updateImageGrid('small');
            } else {
                largeSizeImages.splice(index, 1);
                updateImageGrid('large');
            }
        }

        // FIXED: Load products - Using correct endpoint
        async function loadProducts() {
            try {
                showLoading(true);
                const response = await fetch(`${API_BASE_URL}/GetAllProducts`);
                const data = await response.json();

                if (data.success) {
                    products = data.products || [];
                    renderProducts();
                    updateStats();
                } else {
                    showNotification('Failed to load products: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error loading products:', error);
                showNotification('Failed to load products. Please check your connection.', 'error');
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            const loadingDiv = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');
            const tableBody = document.getElementById('productTableBody');

            if (show) {
                loadingDiv.style.display = 'block';
                emptyState.style.display = 'none';
                tableBody.innerHTML = '';
            } else {
                loadingDiv.style.display = 'none';
            }
        }

        function showLoadingOverlay(show) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = show ? 'flex' : 'none';
        }

        function showNotification(message, type = 'success') {
            const toast = document.getElementById('notificationToast');
            const icon = document.getElementById('toastIcon');
            const messageEl = document.getElementById('toastMessage');

            messageEl.textContent = message;
            toast.className = 'notification-toast show';

            if (type === 'error') {
                toast.classList.add('error');
                icon.className = 'fas fa-times-circle';
            } else if (type === 'warning') {
                toast.classList.add('warning');
                icon.className = 'fas fa-exclamation-triangle';
            } else {
                toast.classList.add('success');
                icon.className = 'fas fa-check-circle';
            }

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function updateStats() {
            const totalProducts = products.length;
            const totalVariants = products.reduce((sum, product) => sum + (product.sizeVariants?.length || 0), 0);
            const availableProducts = products.filter(product =>
                product.sizeVariants?.some(variant => variant.isAvailable)
            ).length;
            const categories = [...new Set(products.map(product => product.category).filter(Boolean))].length;

            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('totalVariants').textContent = totalVariants;
            document.getElementById('availableProducts').textContent = availableProducts;
            document.getElementById('totalCategories').textContent = categories;
        }

        function renderProducts() {
            const tbody = document.getElementById('productTableBody');
            const emptyState = document.getElementById('emptyState');

            if (products.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            tbody.innerHTML = products.map(product => {
                const smallCover = product.images?.find(img => img.sizeType === 'Small' && img.isCover);
                const imageUrl = smallCover?.url || product.images?.[0]?.url || '';

                return `
        <tr>
            <td>
                <img src="${API_BASE_URL + imageUrl}" 
                     alt="${escapeHtml(product.title || 'Product')}" class="product-image"
                     onerror="this.src='https://images.unsplash.com/photo-1578985545062-69928b1d9587?w=300&h=300&fit=crop'">
            </td>
            <td>
                <div class="product-title">${escapeHtml(product.title || 'Untitled')}</div>
                <div class="product-description">${escapeHtml(product.description || 'No description')}</div>
            </td>
            <td>
                <span class="category-badge">${escapeHtml(product.category || 'No category')}</span>
            </td>
            <td>
                <div class="size-variants">
                    ${(product.sizeVariants || []).map(variant => `
                        <div class="size-variant">
                            <span>${escapeHtml(variant.size || 'Unknown')}</span>
                            <div class="variant-price">
                                ${variant.discountedPrice ?
                        `<span class="original-price">${(variant.price || 0).toFixed(2)}</span>
                                     <span class="discounted-price">${(variant.discountedPrice || 0).toFixed(2)}</span>` :
                        `<span>${(variant.price || 0).toFixed(2)}</span>`
                    }
                            </div>
                            <span class="${variant.isAvailable ? 'status-available' : 'status-unavailable'}">
                                <i class="fas ${variant.isAvailable ? 'fa-check' : 'fa-times'}"></i>
                            </span>
                        </div>
                    `).join('')}
                </div>
            </td>
            <td>
                <div class="actions">
                    <button class="action-btn view-btn" onclick="viewProduct('${product._id || product.id}')" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="action-btn edit-btn" onclick="editProduct('${product._id || product.id}')" title="Edit Product">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn delete-btn" onclick="deleteProduct('${product._id || product.id}')" title="Delete Product">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `}).join('');
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function openAddModal() {
            editingProductId = null;
            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-plus-circle"></i> Add Product';
            document.getElementById('productForm').reset();
            document.getElementById('sizeVariantsContainer').innerHTML = '';
            document.getElementById('saveBtn').innerHTML = '<i class="fas fa-save"></i> Save Product';

            smallSizeImages = [];
            largeSizeImages = [];
            initializeImageUploadSections();

            addSizeVariant({ size: 'Small', price: '', discountedPrice: '', isAvailable: true });
            addSizeVariant({ size: 'Large', price: '', discountedPrice: '', isAvailable: true });

            document.getElementById('imageUploadSection').style.display = 'block';
            document.getElementById('productModal').style.display = 'block';
        }

        function addSizeVariant(variant = null) {
            const container = document.getElementById('sizeVariantsContainer');
            const variantId = Date.now() + Math.random();

            const variantHtml = `
        <div class="size-variant-item" id="variant-${variantId}">
            <select required>
                <option value="">Select Size</option>
                <option value="Small" ${variant && variant.size === 'Small' ? 'selected' : ''}>Small</option>
                <option value="Large" ${variant && variant.size === 'Large' ? 'selected' : ''}>Large</option>
            </select>
            <div style="display: flex; flex-direction: column; gap: 4px;">
                <input type="number" placeholder="Original Price" step="0.01" min="0" value="${variant ? variant.price || '' : ''}" required>
                <input type="number" placeholder="Discounted Price (Optional)" step="0.01" min="0" value="${variant ? variant.discountedPrice || '' : ''}">
            </div>
            <div class="checkbox-container">
                <input type="checkbox" ${variant ? (variant.isAvailable !== false ? 'checked' : '') : 'checked'} id="available-${variantId}">
                <label for="available-${variantId}">Available</label>
            </div>
            <button type="button" class="remove-variant-btn" onclick="removeSizeVariant('${variantId}')" title="Remove variant">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;

            container.insertAdjacentHTML('beforeend', variantHtml);
        }

        function removeSizeVariant(variantId) {
            const element = document.getElementById(`variant-${variantId}`);
            if (element && document.querySelectorAll('.size-variant-item').length > 1) {
                element.remove();
            } else {
                showNotification('At least one size variant is required', 'warning');
            }
        }

        // FIXED: Save product - Updated to match backend routes
        async function saveProduct() {
            const title = document.getElementById('productTitle').value.trim();
            const description = document.getElementById('productDescription').value.trim();
            const category = document.getElementById('productCategory').value.trim();

            if (!title || !description || !category) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            const variantElements = document.querySelectorAll('.size-variant-item');
            const sizeVariants = [];

            for (let element of variantElements) {
                const inputs = element.querySelectorAll('input, select');
                const size = inputs[0].value.trim();
                const price = parseFloat(inputs[1].value);
                const discountedPrice = inputs[2].value ? parseFloat(inputs[2].value) : null;
                const isAvailable = inputs[3].checked;

                if (size && !isNaN(price) && price >= 0) {
                    const variant = { size, price, isAvailable };

                    if (discountedPrice !== null && !isNaN(discountedPrice)) {
                        if (discountedPrice >= price) {
                            showNotification(`Discounted price must be less than original price for ${size}`, 'error');
                            return;
                        }
                        variant.discountedPrice = discountedPrice;
                    }

                    sizeVariants.push(variant);
                }
            }

            if (sizeVariants.length === 0) {
                showNotification('Please add at least one valid size variant', 'error');
                return;
            }

            const sizes = sizeVariants.map(v => v.size);
            const uniqueSizes = [...new Set(sizes)];
            if (sizes.length !== uniqueSizes.length) {
                showNotification('Size variants must have unique sizes', 'error');
                return;
            }

            try {
                showLoadingOverlay(true);

                const formData = new FormData();
                formData.append('title', title);
                formData.append('description', description);
                formData.append('category', category);
                formData.append('sizeVariants', JSON.stringify(sizeVariants));

                let response;
                let url;

                if (editingProductId) {
                    // Update existing product
                    formData.append('id', editingProductId);

                    // Debug: Log FormData contents
                    console.log('Updating product with ID:', editingProductId);
                    console.log('FormData contents:');
                    for (let [key, value] of formData.entries()) {
                        console.log(`${key}:`, value);
                    }

                    url = `${API_BASE_URL}/UpdateProduct`;

                    response = await fetch(url, {
                        method: 'POST',
                        body: formData
                    });
                } else {
                    // Create new product with images
                    url = `${API_BASE_URL}/CreateProduct`;

                    // Add images: Small first (8), then Large (8)
                    for (let file of smallSizeImages) {
                        formData.append('images', file);
                    }
                    for (let file of largeSizeImages) {
                        formData.append('images', file);
                    }

                    // Debug: Log FormData contents
                    console.log('Creating new product');
                    console.log('FormData contents:');
                    for (let [key, value] of formData.entries()) {
                        console.log(`${key}:`, value);
                    }

                    response = await fetch(url, {
                        method: 'POST',
                        body: formData
                    });
                }

                const data = await response.json();
                console.log('Server response:', data);

                if (data.success) {
                    showNotification(editingProductId ? 'Product updated successfully' : 'Product created successfully', 'success');
                    closeModal();
                    await loadProducts();
                } else {
                    showNotification(`Failed to ${editingProductId ? 'update' : 'create'} product: ` + (data.message || 'Unknown error'), 'error');
                }

            } catch (error) {
                console.error('Error saving product:', error);
                showNotification(`Failed to ${editingProductId ? 'update' : 'create'} product. Please try again.`, 'error');
            } finally {
                showLoadingOverlay(false);
            }
        }
        // FIXED: Edit product - Using correct endpoint
        async function editProduct(id) {
            try {
                showLoadingOverlay(true);
                const response = await fetch(`${API_BASE_URL}/SingleProduct?id=${id}`);
                const data = await response.json();

                if (!data.success || !data.product) {
                    showNotification('Product not found', 'error');
                    return;
                }

                const product = data.product;
                editingProductId = id;

                document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit"></i> Edit Product';
                document.getElementById('saveBtn').innerHTML = '<i class="fas fa-save"></i> Update Product';
                document.getElementById('productTitle').value = product.title || '';
                document.getElementById('productDescription').value = product.description || '';
                document.getElementById('productCategory').value = product.category || '';

                document.getElementById('imageUploadSection').style.display = 'none';

                const container = document.getElementById('sizeVariantsContainer');
                container.innerHTML = '';

                if (product.sizeVariants && product.sizeVariants.length > 0) {
                    product.sizeVariants.forEach(variant => {
                        addSizeVariant(variant);
                    });
                } else {
                    addSizeVariant();
                }

                document.getElementById('productModal').style.display = 'block';

            } catch (error) {
                console.error('Error loading product for edit:', error);
                showNotification('Failed to load product details', 'error');
            } finally {
                showLoadingOverlay(false);
            }
        }

        // FIXED: View product - Using correct endpoint
        async function viewProduct(id) {
            try {
                showLoadingOverlay(true);

                const response = await fetch(`${API_BASE_URL}/SingleProduct?id=${id}`);
                const data = await response.json();

                if (!data.success || !data.product) {
                    showNotification('Product not found', 'error');
                    return;
                }

                const product = data.product;
                const modalBody = document.getElementById('viewModalBody');

                function getImageUrl(img) {
                    if (typeof img === 'string') return `${API_BASE_URL}${img}`;
                    if (img && typeof img === 'object') {
                        if (img.url) return `${API_BASE_URL}${img.url}`;
                        if (img.path) return `${API_BASE_URL}/${img.path}`;
                        if (img.filename) return `${API_BASE_URL}/uploads/Products/${img.filename}`;
                    }
                    return 'https://images.unsplash.com/photo-1578985545062-69928b1d9587?w=300&h=300&fit=crop';
                }

                const smallImages = product.images?.filter(img => img.sizeType === 'Small') || [];
                const largeImages = product.images?.filter(img => img.sizeType === 'Large') || [];

                const smallCover = smallImages.find(img => img.isCover) || smallImages[0];
                const smallBody = smallImages.filter(img => !img.isCover);

                const largeCover = largeImages.find(img => img.isCover) || largeImages[0];
                const largeBody = largeImages.filter(img => !img.isCover);

                modalBody.innerHTML = `
            <div class="view-product-details">
                <div class="detail-section">
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Product Title</div>
                            <div class="detail-value">${escapeHtml(product.title || 'N/A')}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Category</div>
                            <div class="detail-value">${escapeHtml(product.category || 'N/A')}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Created</div>
                            <div class="detail-value">${product.createdAt ? new Date(product.createdAt).toLocaleDateString() : 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Last Updated</div>
                            <div class="detail-value">${product.updatedAt ? new Date(product.updatedAt).toLocaleDateString() : 'N/A'}</div>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-item">
                        <div class="detail-label">Description</div>
                        <div class="detail-value">${escapeHtml(product.description || 'No description available')}</div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4><i class="fas fa-tags"></i> Size Variants & Pricing</h4>
                    <div class="detail-grid">
                        ${(product.sizeVariants || []).map(variant => `
                            <div class="detail-item">
                                <div class="detail-label">${escapeHtml(variant.size || 'Unknown Size')}</div>
                                <div class="detail-value">
                                    ${variant.discountedPrice ?
                        `<span style="text-decoration: line-through; color: var(--text-muted); margin-right: 8px;">${(variant.price || 0).toFixed(2)}</span> 
                                         <span style="color: var(--success); font-weight: 700; font-size: 1.1rem;">${(variant.discountedPrice || 0).toFixed(2)}</span>
                                         <div style="color: var(--success); font-size: 0.8rem; margin-top: 4px;">
                                            <i class="fas fa-tag"></i> ${Math.round(((variant.price - variant.discountedPrice) / variant.price) * 100)}% OFF
                                         </div>` :
                        `<span style="font-weight: 700; font-size: 1.1rem;">${(variant.price || 0).toFixed(2)}</span>`
                    }
                                    <div style="margin-top: 8px;">
                                        <span style="color: ${variant.isAvailable ? 'var(--success)' : 'var(--error)'};">
                                            <i class="fas ${variant.isAvailable ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                                            ${variant.isAvailable ? 'Available' : 'Unavailable'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4><i class="fas fa-images"></i> Small Size Images (${smallImages.length}/8)</h4>
                    ${smallCover ? `
                        <div style="margin-bottom: 24px;">
                            <h5 style="color: var(--success); margin-bottom: 12px;"><i class="fas fa-image"></i> Cover Photo</h5>
                            <div style="text-align: center; position: relative; display: inline-block;">
                                <img src="${getImageUrl(smallCover)}" alt="Small Cover" 
                                     style="max-width: 300px; max-height: 300px; border-radius: var(--radius); box-shadow: var(--shadow-lg); border: 3px solid var(--success); cursor: pointer;"
                                     class="editable-image"
                                     data-image-id="${smallCover._id || smallCover.id}"
                                     data-product-id="${product._id || product.id}"
                                     data-size-type="Small"
                                     data-is-cover="true">
                                <div class="image-edit-overlay">
                                    <button class="image-action-btn" onclick="updateProductImage('${product._id || product.id}', '${smallCover._id || smallCover.id}')" title="Replace Image">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                    <button class="image-action-btn" onclick="deleteProductImage('${product._id || product.id}', '${smallCover._id || smallCover.id}')" title="Delete Image">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : '<p style="color: var(--text-muted); font-style: italic;">No cover photo for Small size</p>'}
                    
                    ${smallBody.length > 0 ? `
                        <div>
                            <h5 style="color: var(--success); margin-bottom: 12px;"><i class="fas fa-images"></i> Body Images (${smallBody.length})</h5>
                            <div class="image-gallery-grid">
                                ${smallBody.map((img, index) => `
                                    <div class="image-gallery-item" style="position: relative;">
                                        <img src="${getImageUrl(img)}" alt="Small Image ${index + 1}" 
                                             style="width: 200px; height: 200px; object-fit: cover; border-radius: var(--radius); box-shadow: var(--shadow); cursor: pointer;"
                                             class="editable-image"
                                             data-image-id="${img._id || img.id}"
                                             data-product-id="${product._id || product.id}"
                                             data-size-type="Small"
                                             data-is-cover="false">
                                        <div class="image-edit-overlay">
                                            <button class="image-action-btn" onclick="setCoverImage('${product._id || product.id}', '${img._id || img.id}')" title="Set as Cover">
                                                <i class="fas fa-star"></i>
                                            </button>
                                            <button class="image-action-btn" onclick="updateProductImage('${product._id || product.id}', '${img._id || img.id}')" title="Replace Image">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                            <button class="image-action-btn" onclick="deleteProductImage('${product._id || product.id}', '${img._id || img.id}')" title="Delete Image">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>

                <div class="detail-section">
                    <h4><i class="fas fa-images"></i> Large Size Images (${largeImages.length}/8)</h4>
                    ${largeCover ? `
                        <div style="margin-bottom: 24px;">
                            <h5 style="color: var(--primary); margin-bottom: 12px;"><i class="fas fa-image"></i> Cover Photo</h5>
                            <div style="text-align: center; position: relative; display: inline-block;">
                                <img src="${getImageUrl(largeCover)}" alt="Large Cover" 
                                     style="max-width: 300px; max-height: 300px; border-radius: var(--radius); box-shadow: var(--shadow-lg); border: 3px solid var(--primary); cursor: pointer;"
                                     class="editable-image"
                                     data-image-id="${largeCover._id || largeCover.id}"
                                     data-product-id="${product._id || product.id}"
                                     data-size-type="Large"
                                     data-is-cover="true">
                                <div class="image-edit-overlay">
                                    <button class="image-action-btn" onclick="updateProductImage('${product._id || product.id}', '${largeCover._id || largeCover.id}')" title="Replace Image">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                    <button class="image-action-btn" onclick="deleteProductImage('${product._id || product.id}', '${largeCover._id || largeCover.id}')" title="Delete Image">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : '<p style="color: var(--text-muted); font-style: italic;">No cover photo for Large size</p>'}
                    
                    ${largeBody.length > 0 ? `
                        <div>
                            <h5 style="color: var(--primary); margin-bottom: 12px;"><i class="fas fa-images"></i> Body Images (${largeBody.length})</h5>
                            <div class="image-gallery-grid">
                                ${largeBody.map((img, index) => `
                                    <div class="image-gallery-item" style="position: relative;">
                                        <img src="${getImageUrl(img)}" alt="Large Image ${index + 1}" 
                                             style="width: 200px; height: 200px; object-fit: cover; border-radius: var(--radius); box-shadow: var(--shadow); cursor: pointer;"
                                             class="editable-image"
                                             data-image-id="${img._id || img.id}"
                                             data-product-id="${product._id || product.id}"
                                             data-size-type="Large"
                                             data-is-cover="false">
                                        <div class="image-edit-overlay">
                                            <button class="image-action-btn" onclick="setCoverImage('${product._id || product.id}', '${img._id || img.id}')" title="Set as Cover">
                                                <i class="fas fa-star"></i>
                                            </button>
                                            <button class="image-action-btn" onclick="updateProductImage('${product._id || product.id}', '${img._id || img.id}')" title="Replace Image">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                            <button class="image-action-btn" onclick="deleteProductImage('${product._id || product.id}', '${img._id || img.id}')" title="Delete Image">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;

                document.getElementById('viewModal').style.display = 'block';

            } catch (error) {
                console.error('Error loading product details:', error);
                showNotification('Failed to load product details', 'error');
            } finally {
                showLoadingOverlay(false);
            }
        }

        async function updateProductImage(productId, imageId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';

            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (file.size > 5 * 1024 * 1024) {
                    showNotification('Image size must be less than 5MB', 'error');
                    return;
                }

                try {
                    showLoadingOverlay(true);

                    const formData = new FormData();
                    formData.append('productId', productId);
                    formData.append('imageId', imageId);
                    formData.append('image', file);

                    const response = await fetch(`${API_BASE_URL}/UpdateImageInProduct`, {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (data.success) {
                        showNotification('Image updated successfully', 'success');
                        await viewProduct(productId); // Refresh the view
                    } else {
                        showNotification('Failed to update image: ' + data.message, 'error');
                    }
                } catch (error) {
                    console.error('Error updating image:', error);
                    showNotification('Failed to update image', 'error');
                } finally {
                    showLoadingOverlay(false);
                }
            };

            input.click();
        }
        async function deleteProductImage(productId, imageId) {
            if (!confirm('Are you sure you want to delete this image? This action cannot be undone.')) return;

            try {
                showLoadingOverlay(true);

                const response = await fetch(`${API_BASE_URL}/DeleteImageFromProduct`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        productId: productId,
                        imageId: imageId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('Image deleted successfully', 'success');
                    await viewProduct(productId); // Refresh the view
                } else {
                    showNotification('Failed to delete image: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting image:', error);
                showNotification('Failed to delete image', 'error');
            } finally {
                showLoadingOverlay(false);
            }
        }
        async function setCoverImage(productId, imageId) {
            if (!confirm('Set this image as the cover photo for its size?')) return;

            try {
                showLoadingOverlay(true);

                const response = await fetch(`${API_BASE_URL}/SetCoverImage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        productId: productId,
                        imageId: imageId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('Cover image updated successfully', 'success');
                    await viewProduct(productId); // Refresh the view
                } else {
                    showNotification('Failed to update cover image: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error setting cover image:', error);
                showNotification('Failed to update cover image', 'error');
            } finally {
                showLoadingOverlay(false);
            }
        }

        // FIXED: Delete product - Using GET method as per backend
        async function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product? All associated images will also be deleted.')) {
                try {
                    showLoadingOverlay(true);
                    const response = await fetch(`${API_BASE_URL}/DeleteProduct?id=${id}`, {
                        method: 'GET',
                    });

                    const data = await response.json();

                    if (data.success) {
                        showNotification('Product deleted successfully', 'success');
                        await loadProducts();
                    } else {
                        showNotification('Failed to delete product: ' + data.message, 'error');
                    }
                } catch (error) {
                    console.error('Error deleting product:', error);
                    showNotification('Failed to delete product. Please try again.', 'error');
                } finally {
                    showLoadingOverlay(false);
                }
            }
        }

        function closeModal() {
            document.getElementById('productModal').style.display = 'none';
            editingProductId = null;
            document.getElementById('productForm').reset();
            smallSizeImages = [];
            largeSizeImages = [];
            document.getElementById('imageUploadSection').style.display = 'block';
            initializeImageUploadSections();
        }

        function closeViewModal() {
            document.getElementById('viewModal').style.display = 'none';
        }

        window.onclick = function (event) {
            const productModal = document.getElementById('productModal');
            const viewModal = document.getElementById('viewModal');

            if (event.target === productModal) {
                closeModal();
            }
            if (event.target === viewModal) {
                closeViewModal();
            }
        }

        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                closeModal();
                closeViewModal();
            }
        });

        document.getElementById('notificationToast').addEventListener('click', function () {
            this.classList.remove('show');
        });

        document.addEventListener('DOMContentLoaded', function () {
            initializeData();
            initializeImageUploadSections();
        });
    </script>
</body>

</html>